function [xi, end_check] = trajectory_generation(u, xi_0, T_end, Ts)
%         Input:      u: input (torque, delta)
%                     xi_0: initial conditions
%                     T_end: simulation time
%                     Ts: time step for the numerical simulation
%                     
%         Output:     xi: state of the system wrt time
%                     flag:   1: ok
%                             0: input di dimensione errata

end_check = 1;
t_vec = 0:Ts:(T_end-Ts);
N = length(t_vec);

%% dimensional check

if N != 2*length(u)
    end_check =  0;
    xi=0;
    return
end

%% inizializzazione

T_in = u_opt(1:N);
delta_in = u_opt((N+1):(2*N));

tau                 =       0;
d                   =       0;

xi = zeros(6,length(T

for i = 2:T_end %end of the iteration when we reach the final wl
    
  % current wayline selection  
  current_wl    =     current_wayline(inner_wl,outer_wl,boundary_number,innerBoundary,outerBoundary,n_wl,N);

%   if (current_wl == n_wl)
  % If we are in correspondence of the last wayline we have to keep the
  % optimal values until we reach the end of the track, otherwise we'll
  % have computational problem.
%       u_output          =           [T_opt(current_wl);delta_opt(current_wl)];
  
%   else
      
      % interpolator

      d_interpolated    =       interpolator_bws( inner_wl(current_wl,1:2),outer_wl(current_wl,1:2),inner_wl(current_wl+1,1:2),outer_wl(current_wl+1,1:2),xi_sim(1,i-1),xi_sim(2,i-1));

      T_kp1             =       T_in(current_wl) + (T_in(current_wl+1) - T_in(current_wl))*d_interpolated;
      delta_kp1         =       delta_in(current_wl) + (delta_in(current_wl+1) - delta_in(current_wl))*d_interpolated;

      u_output          =       [T_kp1;delta_kp1];
  
%   end
  
  % from the output of the interpolator to the new state
  xi_sim(:,i) = xi_sim(:,i-1) + Ts*Vehicle_Model_Function(0, xi_sim(:,i-1),u_output, 0, theta);
  
  % check if the target position is feasible
  [inside, boundary_number] = track_constraints(xi_sim(1,i),xi_sim(2,i),N,innerBoundary,outerBoundary,boundary_number);
 
  % if the target position is feasible, update of the state with the new
  % position. else exit the for cycle, because the trajectory is not
  % feasible.
  
  if inside == 1
     %plot([xi_sim(1,i) xi_sim(1,i-1)],[xi_sim(2,i) xi_sim(2,i-1)]);%     
  else
      time=-1;
      end_check = 0;
      return
  end
  
end

time = Ts*i;


